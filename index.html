<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>もちもちの子の大冒険</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; overscroll-behavior: none; touch-action: none;
        }
        h1 { 
            position: absolute; top: 10px; width: 100%; text-align: center;
            color: #6495ed; animation: bounce 1s infinite alternate; z-index: 10;
        }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }
        
        #stage {
            width: 100vw; height: 100vh;
            background-color: #8bc34a;
            background-image: radial-gradient(#9ccc65 20%, transparent 20%), 
                              radial-gradient(#9ccc65 20%, transparent 20%);
            background-size: 50px 50px; background-position: 0 0, 25px 25px;
        }

        #player {
            width: 30%; height: 30%;
            position: absolute; top: 0; left: 0;
            --poster-color: transparent;
        }

        /* ★スマホ操作ボタンの見た目 */
        #controls {
            position: fixed; bottom: 30px; left: 30px; z-index: 100;
            display: grid; grid-template-columns: 60px 60px 60px; grid-template-rows: 60px 60px;
            gap: 10px;
        }
        .btn {
            width: 60px; height: 60px; background: rgba(255, 255, 255, 0.7);
            border: 2px solid #333; border-radius: 50%; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }
        .btn:active { background: rgba(100, 200, 255, 0.8); }
        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-down { grid-column: 2; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }
    </style>
</head>
<body>

<h1>Hello!<br> Welcome to AOKUJILab.</h1>

<div id="stage">
    <model-viewer id="player"
        src="first_kemono_animation.glb" 
        autoplay animation-name="idle"
        shadow-intensity="1" environment-image="neutral">
    </model-viewer>
</div>

<div id="controls">
    <div class="btn" id="btn-up">▲</div>
    <div class="btn" id="btn-left">◀</div>
    <div class="btn" id="btn-down">▼</div>
    <div class="btn" id="btn-right">▶</div>
</div>

<script>
    const model = document.querySelector('#player');
    let posX = window.innerWidth / 2 - 50; 
    let posZ = window.innerHeight / 2 - 50;
    let rotation = 180;
    const walkSpeed = 3; // 少し速くしました
    const turnSpeed = 4;
    const keys = {};

    // スクロール禁止のおまじない
    window.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });

    function setupButton(id, keyName) {
        const el = document.querySelector(id);
        if (!el) return;
        const start = (e) => { e.preventDefault(); keys[keyName] = true; };
        const end = () => { keys[keyName] = false; model.animationName = "idle"; };
        el.addEventListener('touchstart', start, {passive: false});
        el.addEventListener('touchend', end);
        el.addEventListener('mousedown', start);
        el.addEventListener('mouseup', end);
        el.addEventListener('mouseleave', end);
    }

    setupButton('#btn-up', 'ArrowUp');
    setupButton('#btn-down', 'ArrowDown');
    setupButton('#btn-left', 'ArrowLeft');
    setupButton('#btn-right', 'ArrowRight');

    window.addEventListener('keydown', e => keys[e.key] = true);
    window.addEventListener('keyup', e => {
        keys[e.key] = false;
        if(!keys['ArrowUp'] && !keys['ArrowDown'] && !keys['ArrowLeft'] && !keys['ArrowRight']){
            model.animationName = "idle";
        }
    });

    function update() {
        let moving = false;
        if (keys['ArrowLeft'] || keys['a']) { rotation += turnSpeed; }
        if (keys['ArrowRight'] || keys['d']) { rotation -= turnSpeed; }

        const rad = (rotation * Math.PI) / 180;
        if (keys['ArrowUp'] || keys['w']) {
            posX += Math.sin(rad) * walkSpeed;
            posZ += Math.cos(rad) * walkSpeed;
            moving = true;
        }
        if (keys['ArrowDown'] || keys['s']) {
            posX -= Math.sin(rad) * walkSpeed;
            posZ -= Math.cos(rad) * walkSpeed;
            moving = true;
        }

        // 壁の判定
        posX = Math.max(0, Math.min(window.innerWidth - 100, posX));
        posZ = Math.max(0, Math.min(window.innerHeight - 100, posZ));

        if (moving) { model.animationName = "walk"; }

        model.style.left = `${posX}px`;
        model.style.top = `${posZ}px`;
        model.orientation = `0deg 0deg ${rotation}deg`;

        requestAnimationFrame(update);
    }
    update();
</script>
</body>
</html>
