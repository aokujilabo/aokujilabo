<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>もちもちの子の大冒険</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #e0f7fa; } /* 空の色 */
        h1 { color: #6495ed; animation: bounce 1s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }
        
        /* 地面（エリア）の設定 */
        #stage {
            width: 100vw; height: 100vh;
            background-color: #8bc34a; /* 草原の色 */
            background-image: radial-gradient(#9ccc65 20%, transparent 20%), 
                              radial-gradient(#9ccc65 20%, transparent 20%);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
        }

        /* キャラクターの表示サイズ */
        #player {
            width: 10%; height: 10%;
            position: absolute; top: 0; left: 0;
            --poster-color: transparent;
        }
    </style>
</head>
<body>

    <h1>Hello!<br> Welcome to AOKUJILab.</h1>
<div id="stage">
    <model-viewer id="player"
        src="first_kemono_animation.glb" 
        autoplay
        animation-name="idle"
        shadow-intensity="1"
        environment-image="neutral"
        camera-controls
        touch-action="none">
    </model-viewer>
</div>

<script>
    const model = document.querySelector('#player');
    let posX = window.innerWidth / 2, posZ = window.innerHeight / 2; // 初期位置を画面中央付近に
    let rotation = 180; // 向き（角度）
    const walkSpeed = 3; // 前進速度
    const turnSpeed = 3; // 回転速度
    const keys = {};

    // エリアの制限（壁）
    const minX = 0, maxX = window.innerWidth - 100;
    const minZ = 0, maxZ = window.innerHeight - 100;

    window.addEventListener('keydown', e => keys[e.key] = true);
    window.addEventListener('keyup', e => {
        keys[e.key] = false;
        // 何も押してなければアイドルへ（Walkキーが離された時のみ）
        if(!keys['ArrowUp'] && !keys['w'] && !keys['ArrowDown'] && !keys['s']){
            model.animationName = "idle"; 
        }
    });

    function update() {
        let moving = false;
        
        // 左右で回転（向きを変える）
        if (keys['ArrowLeft'] || keys['a']) { rotation += turnSpeed; }
        if (keys['ArrowRight'] || keys['d']) { rotation -= turnSpeed; }

        // 上下で「向いている方向」に対して前進・後退
        // 角度をラジアンに変換して計算
        const rad = (rotation * Math.PI) / 180;

        if (keys['ArrowUp'] || keys['w']) {
            posX += Math.sin(rad) * walkSpeed;
            posZ += Math.cos(rad) * walkSpeed;
            moving = true;
        }
        if (keys['ArrowDown'] || keys['s']) {
            posX -= Math.sin(rad) * walkSpeed;
            posZ -= Math.cos(rad) * walkSpeed;
            moving = true;
        }

        // 壁の判定（エリア外に出ないようにする）
        posX = Math.max(minX, Math.min(maxX, posX));
        posZ = Math.max(minZ, Math.min(maxZ, posZ));

        if (moving) {
            model.animationName = "walk";
        }

        // 表示の更新
        model.style.left = `${posX}px`;
        model.style.top = `${posZ}px`;
        model.orientation = `0deg 0deg ${rotation}deg`;

        requestAnimationFrame(update);
    }
    update();
</script>
</html>
