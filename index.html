<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>もちもちの子の大冒険</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            /* 画面からはみ出た部分を隠し、スクロールを禁止する */
            overflow: hidden; 
            /* 指で引っ張った時の「バウンド（跳ね返り）」を防止 */
            overscroll-behavior: none; 
            /* タッチ操作のデフォルト挙動（ズームやスクロール）を無効化 */
            touch-action: none; 
        }
        
        /* 操作ボタンだけはタッチに反応するように、個別に設定 */
        .btn {
            touch-action: manipulation; 
            /* 長押しによるメニュー（コピーなど）を禁止 */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        h1 { color: #6495ed; animation: bounce 1s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }
        
        /* 地面（エリア）の設定 */
        #stage {
            width: 100vw; height: 100vh;
            background-color: #8bc34a; /* 草原の色 */
            background-image: radial-gradient(#9ccc65 20%, transparent 20%), 
                              radial-gradient(#9ccc65 20%, transparent 20%);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
        }

        /* キャラクターの表示サイズ */
        #player {
            width: 30%; height: 30%;
            position: absolute; top: 0; left: 0;
            --poster-color: transparent;
        }
    </style>
</head>
<body>

    <h1>Hello!<br> Welcome to AOKUJILab.</h1>
<div id="stage">
    <model-viewer id="player"
        src="first_kemono_animation.glb" 
        autoplay
        animation-name="idle"
        shadow-intensity="1"
        environment-image="neutral"
        touch-action="none">
    </model-viewer>
</div>

<script>
    const model = document.querySelector('#player');
    let posX = window.innerWidth / 2, posZ = window.innerHeight / 2; // 初期位置を画面中央付近に
    let rotation = 180; // 向き（角度）
    const walkSpeed = 1; // 前進速度
    const turnSpeed = 3; // 回転速度
    const keys = {};

    // ★ここに「2のやつ（ボタン設定）」を入れる
    function setupButton(id, keyName) {
        const el = document.querySelector(id);
        if (!el) return;

        // スマホ用（タッチ）
        el.addEventListener('touchstart', (e) => { 
            e.preventDefault(); // ズームやスクロールを防ぐ
            keys[keyName] = true; 
        }, {passive: false});
        el.addEventListener('touchend', () => { 
            keys[keyName] = false; 
            model.animationName = "idle"; 
        });

        // PCでマウスでポチポチしたい用
        el.addEventListener('mousedown', () => { keys[keyName] = true; });
        el.addEventListener('mouseup', () => { 
            keys[keyName] = false; 
            model.animationName = "idle"; 
        });
        // ボタンの外にマウスが外れた時も止まるように
        el.addEventListener('mouseleave', () => { keys[keyName] = false; });
    }

    // 各ボタンを紐付け
    setupButton('#btn-up', 'ArrowUp');
    setupButton('#btn-down', 'ArrowDown');
    setupButton('#btn-left', 'ArrowLeft');
    setupButton('#btn-right', 'ArrowRight');
    
    // エリアの制限（壁）
    const minX = 0, maxX = window.innerWidth - 100;
    const minZ = 0, maxZ = window.innerHeight - 100;

    window.addEventListener('keydown', e => keys[e.key] = true);
    window.addEventListener('keyup', e => {
        keys[e.key] = false;
        // 何も押してなければアイドルへ（Walkキーが離された時のみ）
        if(!keys['ArrowUp'] && !keys['w'] && !keys['ArrowDown'] && !keys['s']){
            model.animationName = "idle"; 
        }
    });

    function update() {
        // 画面全体のタッチ移動（スクロール）をイベントレベルで禁止する
        window.addEventListener('touchmove', (e) => {
            // ボタン操作以外の場所でのスクロールを防止
            e.preventDefault();
        }, { passive: false });
        let moving = false;
        
        // 左右で回転（向きを変える）
        if (keys['ArrowLeft'] || keys['a']) { rotation += turnSpeed; }
        if (keys['ArrowRight'] || keys['d']) { rotation -= turnSpeed; }

        // 上下で「向いている方向」に対して前進・後退
        // 角度をラジアンに変換して計算
        const rad = (rotation * Math.PI) / 180;

        if (keys['ArrowUp'] || keys['w']) {
            posX += Math.sin(rad) * walkSpeed;
            posZ += Math.cos(rad) * walkSpeed;
            moving = true;
        }
        if (keys['ArrowDown'] || keys['s']) {
            posX -= Math.sin(rad) * walkSpeed;
            posZ -= Math.cos(rad) * walkSpeed;
            moving = true;
        }

        // 壁の判定（エリア外に出ないようにする）
        posX = Math.max(minX, Math.min(maxX, posX));
        posZ = Math.max(minZ, Math.min(maxZ, posZ));

        if (moving) {
            model.animationName = "walk";
        }

        // 表示の更新
        model.style.left = `${posX}px`;
        model.style.top = `${posZ}px`;
        model.orientation = `0deg 0deg ${rotation}deg`;

        requestAnimationFrame(update);
    }
    update();
</script>
</html>
